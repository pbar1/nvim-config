version: '3'

vars:
  BIN: '{{osBase .PWD}}'
  IMAGE: ghcr.io/pbar1/{{.BIN}}
  VERSION:
    sh: git describe --tags --always --dirty

tasks:
  default: task --list

  clean:
    desc: Remove generated files and container images.
    cmds:
    - rm -rf run/ plugin/ || true
    - docker rmi {{.IMAGE}}:{{.VERSION}} || true

  link:
    cmds:
    - mkdir -p run/config/nvim run/data run/cache
    - ln -s ${PWD}/init.lua run/config/nvim || true
    - ln -s ${PWD}/lua run/config/nvim || true
    status:
    - ls run/config/nvim/init.lua
    - ls run/config/nvim/lua
    - ls run/data
    - ls run/cache

  run:
    desc: Launches an instance of Neovim using this config.
    deps:
    - link
    cmds:
    - XDG_CONFIG_HOME=run/config XDG_DATA_HOME=run/data XDG_CACHE_HOME=run/cache nvim {{.CLI_ARGS}}

  version:
    desc: Print version string that will be used
    cmds:
    - echo {{.VERSION}}

  image:
    desc: Alias for "image:build"
    deps:
    - image:build

  image:name:
    desc: Print container image name that will be used
    cmds:
    - echo {{.IMAGE}}:{{.VERSION}}

  # TODO: Implement multiplatform container images with --platform
  image:build:
    desc: Build container image
    cmds:
    - docker build --tag={{.IMAGE}}:{{.VERSION}} .
    status:
    - docker inspect --type=image {{.IMAGE}}:{{.VERSION}}

  image:push:
    desc: Push container image to remote repository
    deps:
    - image:build
    cmds:
    - docker tag {{.IMAGE}}:{{.VERSION}} {{.IMAGE}}:latest
    - docker push {{.IMAGE}}:{{.VERSION}}
    - docker push {{.IMAGE}}:latest

  fmt:
    desc: Formats code in this project.
    cmds:
    - stylua init.lua lua/
